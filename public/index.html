<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Chat + Drawing App</title>
  <style>
    .chat {
      display: flex;
      flex-direction: column;
      height: 60vh;
      margin-bottom: 10px;
    }
    .messages {
      flex: 1;
      overflow-y: auto;
      list-style: none;
      padding: 0;
      margin: 0;
      border: 1px solid #ccc;
    }
    .form {
      display: flex;
    }
    .input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
    }
    .submit {
      padding: 10px;
      border: 1px solid #ccc;
      background: #eee;
      cursor: pointer;
    }
    #toolbar {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .stamp-btn {
      font-size: 24px;
      border: none;
      background: transparent;
      cursor: pointer;
    }
    .selected {
      outline: 2px solid #333;
    }
    #eraserBtn.active {
      background: #faa;
    }
    canvas {
      border: 1px solid #000;
      touch-action: none;
    }
  </style>
</head>
<body>
  <!-- „ÉÅ„É£„ÉÉ„ÉàÈ†òÂüü -->
  <div class="chat">
    <ul class="messages"></ul>
    <form class="form">
      <input class="input" autocomplete="off" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏‚Ä¶" />
      <button class="submit">Send</button>
    </form>
  </div>

  <!-- „ÉÑ„Éº„É´„Éê„Éº -->
  <div id="toolbar">
    <label>
      Á∑ö„ÅÆËâ≤:
      <input type="color" id="colorPicker" value="#000000" />
    </label>
    <span>„Çπ„Çø„É≥„Éó:</span>
    <button class="stamp-btn" data-stamp="üå∏">üå∏</button>
    <button class="stamp-btn" data-stamp="‚≠ê">‚≠ê</button>
    <button class="stamp-btn" data-stamp="üëç">üëç</button>
    <button id="eraserBtn">Ê∂à„Åó„Ç¥„É†</button>
    <button id="clearBtn">„ÇØ„É™„Ç¢</button>
  </div>

  <!-- ÊèèÁîª„Ç≠„É£„É≥„Éê„Çπ -->
  <canvas id="canvas" width="600" height="600"></canvas>

  <script>
    function main() {
      const host = location.origin.replace(/^http/, 'ws')
      const ws   = new WebSocket(host + '/ws')
      const myId = crypto.randomUUID().substr(0,8)

      // DOMÂèñÂæó
      const messageList = document.querySelector('.messages')
      const form        = document.querySelector('.form')
      const inputChat   = document.querySelector('.input')
      const canvas      = document.getElementById('canvas')
      const ctx         = canvas.getContext('2d')
      const colorPicker = document.getElementById('colorPicker')
      const stamps      = document.querySelectorAll('.stamp-btn')
      const eraserBtn   = document.getElementById('eraserBtn')
      const clearBtn    = document.getElementById('clearBtn')

      // Áä∂ÊÖãÂ§âÊï∞
      let tool         = 'pen'       // 'pen'ÔΩú'stamp'ÔΩú'eraser'
      let currentStamp = null
      let drawing      = false

      // ÂàùÊúüË®≠ÂÆö
      ctx.lineWidth   = 3
      ctx.lineCap     = 'round'
      ctx.strokeStyle = colorPicker.value

      // „Ç´„É©„Éº„Éî„ÉÉ„Ç´„Éº
      colorPicker.addEventListener('input', () => {
        ctx.strokeStyle = colorPicker.value
      })

      // „Çπ„Çø„É≥„ÉóÈÅ∏Êäû
      stamps.forEach(btn => {
        btn.addEventListener('click', () => {
          if (tool === 'stamp' && currentStamp === btn.dataset.stamp) {
            tool = 'pen'
            currentStamp = null
            btn.classList.remove('selected')
          } else {
            tool = 'stamp'
            currentStamp = btn.dataset.stamp
            stamps.forEach(b => b.classList.remove('selected'))
            btn.classList.add('selected')
          }
          eraserBtn.classList.remove('active')
          ctx.globalCompositeOperation = 'source-over'
        })
      })

      // Ê∂à„Åó„Ç¥„É†Âàá„ÇäÊõø„Åà
      eraserBtn.addEventListener('click', () => {
        if (tool === 'eraser') {
          tool = 'pen'
          eraserBtn.classList.remove('active')
          ctx.globalCompositeOperation = 'source-over'
        } else {
          tool = 'eraser'
          eraserBtn.classList.add('active')
          ctx.globalCompositeOperation = 'destination-out'
        }
        stamps.forEach(b => b.classList.remove('selected'))
        currentStamp = null
      })

      // „ÇØ„É™„Ç¢
      clearBtn.addEventListener('click', () => {
        clearCanvas()
        ws.send(JSON.stringify({ type: 'clear' }))
      })

      // „Çπ„Çø„É≥„ÉóÈÖçÁΩÆ
      canvas.addEventListener('click', e => {
        if (tool === 'stamp' && currentStamp) {
          const x = e.offsetX, y = e.offsetY
          drawStamp(currentStamp, x, y)
          ctx.beginPath()
          ws.send(JSON.stringify({ type: 'stamp', stamp: currentStamp, x, y }))
          // „É¢„Éº„ÉâÊàª„Åô
          tool = 'pen'
          stamps.forEach(b => b.classList.remove('selected'))
          currentStamp = null
        }
      })

      // „Éö„É≥ÔºèÊ∂à„Åó„Ç¥„É†ÊèèÁîª
      canvas.addEventListener('mousedown', e => {
        if (tool === 'pen' || tool === 'eraser') {
          drawing = true
          ctx.beginPath()
          ctx.moveTo(e.offsetX, e.offsetY)
          ws.send(JSON.stringify({
            type: 'paint', control: 'mousedown', x: e.offsetX, y: e.offsetY
          }))
        }
      })
      canvas.addEventListener('mousemove', e => {
        if (drawing && (tool === 'pen' || tool === 'eraser')) {
          ctx.lineTo(e.offsetX, e.offsetY)
          ctx.stroke()
          ws.send(JSON.stringify({
            type: 'paint', control: 'mousemove', x: e.offsetX, y: e.offsetY
          }))
        }
      })
      canvas.addEventListener('mouseup', e => {
        if (drawing) {
          drawing = false
          ctx.beginPath()
          ws.send(JSON.stringify({
            type: 'paint', control: 'mouseup', x: e.offsetX, y: e.offsetY
          }))
        }
      })
      canvas.addEventListener('mouseout', e => {
        if (drawing) {
          drawing = false
          ctx.beginPath()
          ws.send(JSON.stringify({
            type: 'paint', control: 'mouseout', x: e.offsetX, y: e.offsetY
          }))
        }
      })

      // WebSocketÂèó‰ø°
      ws.onmessage = ev => {
        const msg = JSON.parse(ev.data)
        if (msg.type === 'paint') {
          const { control, x, y } = msg
          if (control === 'mousedown') {
            ctx.beginPath()
            ctx.moveTo(x, y)
          } else if (control === 'mousemove') {
            ctx.lineTo(x, y)
            ctx.stroke()
          } else {
            // mouseup Ôºè mouseout
            ctx.beginPath()
          }
        }
        else if (msg.type === 'stamp') {
          drawStamp(msg.stamp, msg.x, msg.y)
          ctx.beginPath()
        }
        else if (msg.type === 'clear') {
          clearCanvas()
        }
        else if (msg.type === 'chat') {
          const li = document.createElement('li')
          li.textContent = msg.id === myId
            ? `(${msg.id}) Ëá™ÂàÜ: ${msg.text}`
            : `${msg.id}: ${msg.text}`
          messageList.appendChild(li)
          messageList.scrollTop = messageList.scrollHeight
        }
      }
      ws.onerror = err => console.error(err)

      // helper
      function drawStamp(stamp, x, y) {
        ctx.save()
        ctx.font = '32px sans-serif'
        ctx.textAlign = 'center'
        ctx.fillText(stamp, x, y + 10)
        ctx.restore()
      }
      function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height)
        ctx.beginPath()
      }

      // „ÉÅ„É£„ÉÉ„ÉàÈÄÅ‰ø°
      form.addEventListener('submit', e => {
        e.preventDefault()
        ws.send(JSON.stringify({
          type: 'chat', id: myId, text: inputChat.value
        }))
        inputChat.value = ''
        inputChat.focus()
      })
    }

    main()
  </script>
</body>
</html>