<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat+Drawing App</title>
    <style>
      .chat {
        display: flex;
        flex-direction: column;
        height: 40vh;
        margin-bottom: 10px;
      }
      .messages {
        flex: 1;
        overflow-y: auto;
        list-style: none;
        padding: 0;
        margin: 0;
        border: 1px solid #ccc;
      }
      .form {
        display: flex;
      }
      .input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
      }
      .submit {
        padding: 10px;
        border: 1px solid #ccc;
        background: #eee;
        cursor: pointer;
      }
      #toolbar {
        margin: 10px 0;
      }
      #toolbar > * {
        margin-right: 10px;
      }
      .stamp-btn {
        font-size: 24px;
        cursor: pointer;
        background: transparent;
        border: none;
      }
      .selected {
        outline: 2px solid #333;
      }
      #eraserBtn.active {
        background: #faa;
      }
    </style>
  </head>
  <body>
    <!-- „ÉÅ„É£„ÉÉ„ÉàÈ†òÂüü -->
    <div class="chat">
      <ul class="messages"></ul>
      <form class="form">
        <input class="input" autocomplete="off" />
        <button class="submit">Send</button>
      </form>
    </div>

    <!-- „ÉÑ„Éº„É´„Éê„Éº -->
    <div id="toolbar">
      <!-- Ëâ≤ÈÅ∏Êäû -->
      <label>
        Á∑ö„ÅÆËâ≤:
        <input type="color" id="colorPicker" value="#000000" />
      </label>
      <!-- „Çπ„Çø„É≥„Éó -->
      <span>„Çπ„Çø„É≥„Éó:</span>
      <button class="stamp-btn" data-stamp="üå∏">üå∏</button>
      <button class="stamp-btn" data-stamp="‚≠ê">‚≠ê</button>
      <button class="stamp-btn" data-stamp="üëç">üëç</button>
      <!-- Ê∂à„Åó„Ç¥„É† -->
      <button id="eraserBtn">Ê∂à„Åó„Ç¥„É†</button>
      <!-- „ÇØ„É™„Ç¢ -->
      <button id="clearBtn">„ÇØ„É™„Ç¢</button>
    </div>

    <!-- ÊèèÁîª„Ç≠„É£„É≥„Éê„Çπ -->
    <canvas
      id="canvas"
      width="600"
      height="600"
      style="border: solid 1px black"
    ></canvas>

    <script>
      function main() {
        const host = location.origin.replace(/^http/, 'ws');
        const ws = new WebSocket(host + '/ws');
        const myId = crypto.randomUUID().substr(0, 8);

        // DOMÂèñÂæó
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const colorPicker = document.getElementById('colorPicker');
        const stamps = document.querySelectorAll('.stamp-btn');
        const eraserBtn = document.getElementById('eraserBtn');
        const clearBtn = document.getElementById('clearBtn');

        // „ÉÑ„Éº„É´Áä∂ÊÖã
        let tool = 'pen';         // 'pen' | 'stamp' | 'eraser'
        let currentStamp = null;
        let drawing = false;

        // ÂàùÊúüË®≠ÂÆö
        ctx.lineWidth = 5;
        ctx.lineCap = 'round';
        ctx.strokeStyle = colorPicker.value;

        // Ëâ≤ÈÅ∏Êäû„Ç§„Éô„É≥„Éà
        colorPicker.addEventListener('input', () => {
          ctx.strokeStyle = colorPicker.value;
        });

        // „Çπ„Çø„É≥„ÉóÈÅ∏Êäû
        stamps.forEach(btn => {
          btn.addEventListener('click', () => {
            if (tool === 'stamp' && currentStamp === btn.dataset.stamp) {
              // Âêå„Åò„Çπ„Çø„É≥„Éó„ÇíÂÜçÈÅ∏Êäû„Åó„Åü„Çâ„Éö„É≥„Å´Êàª„Åô
              tool = 'pen';
              currentStamp = null;
              btn.classList.remove('selected');
            } else {
              tool = 'stamp';
              currentStamp = btn.dataset.stamp;
              stamps.forEach(b => b.classList.remove('selected'));
              btn.classList.add('selected');
            }
            // Ê∂à„Åó„Ç¥„É†OFF
            eraserBtn.classList.remove('active');
            ctx.globalCompositeOperation = 'source-over';
          });
        });

        // Ê∂à„Åó„Ç¥„É†Âàá„ÇäÊõø„Åà
        eraserBtn.addEventListener('click', () => {
          if (tool === 'eraser') {
            tool = 'pen';
            eraserBtn.classList.remove('active');
            ctx.globalCompositeOperation = 'source-over';
          } else {
            tool = 'eraser';
            eraserBtn.classList.add('active');
            ctx.globalCompositeOperation = 'destination-out';
          }
          // „Çπ„Çø„É≥„ÉóÈÅ∏ÊäûËß£Èô§
          stamps.forEach(b => b.classList.remove('selected'));
          currentStamp = null;
        });

        // „ÇØ„É™„Ç¢
        clearBtn.addEventListener('click', () => {
          clearCanvas();
          ws.send(JSON.stringify({ type: 'clear' }));
        });

        // „Ç≠„É£„É≥„Éê„Çπ„ÇØ„É™„ÉÉ„ÇØÔºà„Çπ„Çø„É≥„ÉóÈÖçÁΩÆÔºâ
        canvas.addEventListener('click', (e) => {
          if (tool === 'stamp' && currentStamp) {
            const x = e.offsetX;
            const y = e.offsetY;
            drawStamp(currentStamp, x, y);
            ws.send(JSON.stringify({
              type: 'stamp',
              stamp: currentStamp,
              x, y
            }));
            // „Éö„É≥„Å´Êàª„Åô
            tool = 'pen';
            stamps.forEach(b => b.classList.remove('selected'));
            currentStamp = null;
          }
        });

        // „Éö„É≥ÔºèÊ∂à„Åó„Ç¥„É†ÊèèÁîª
        canvas.addEventListener('mousedown', e => {
          if (tool === 'pen' || tool === 'eraser') {
            drawing = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
            ws.send(JSON.stringify({
              type: 'paint',
              control: 'mousedown',
              x: e.offsetX,
              y: e.offsetY
            }));
          }
        });
        canvas.addEventListener('mousemove', e => {
          if (drawing && (tool === 'pen' || tool === 'eraser')) {
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
            ws.send(JSON.stringify({
              type: 'paint',
              control: 'mousemove',
              x: e.offsetX,
              y: e.offsetY
            }));
          }
        });
        canvas.addEventListener('mouseup', e => {
          if (drawing) {
            drawing = false;
            ctx.beginPath();
            ws.send(JSON.stringify({
              type: 'paint',
              control: 'mouseup',
              x: e.offsetX,
              y: e.offsetY
            }));
          }
        });
        canvas.addEventListener('mouseout', e => {
          if (drawing) {
            drawing = false;
            ctx.beginPath();
            ws.send(JSON.stringify({
              type: 'paint',
              control: 'mouseout',
              x: e.offsetX,
              y: e.offsetY
            }));
          }
        });

        // WebSocket Âèó‰ø°
        ws.onmessage = ev => {
          const msg = JSON.parse(ev.data);
          switch (msg.type) {
            case 'paint':
              handleRemotePaint(msg);
              break;
            case 'stamp':
              drawStamp(msg.stamp, msg.x, msg.y);
              break;
            case 'clear':
              clearCanvas();
              break;
            case 'chat':
              appendChat(msg);
              break;
          }
        };

        ws.onerror = err => console.error('WebSocket Error:', err);

        // „É™„É¢„Éº„ÉàÊèèÁîª„Éè„É≥„Éâ„É©
        function handleRemotePaint({ control, x, y }) {
          if (control === 'mousedown') {
            ctx.beginPath();
            ctx.moveTo(x, y);
          } else if (control === 'mousemove') {
            ctx.lineTo(x, y);
            ctx.stroke();
          } else if (control === 'mouseup' || control === 'mouseout') {
            ctx.beginPath();
          }
        }

        // „Çπ„Çø„É≥„ÉóÊèèÁîª
        function drawStamp(stamp, x, y) {
          ctx.save();
          ctx.font = '32px serif';
          ctx.textAlign = 'center';
          ctx.fillText(stamp, x, y + 10);
          ctx.restore();
        }

        // „Ç≠„É£„É≥„Éê„Çπ„ÇØ„É™„Ç¢
        function clearCanvas() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.beginPath();
        }

        // „ÉÅ„É£„ÉÉ„ÉàËøΩÂä†
        function appendChat({ id, text }) {
          const ul = document.querySelector('.messages');
          const li = document.createElement('li');
          li.textContent =
            id === myId ? `(${id}) Ëá™ÂàÜ: ${text}` : `${id}: ${text}`;
          ul.appendChild(li);
          ul.scrollTop = ul.scrollHeight;
        }

        // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°Ôºà„ÉÅ„É£„ÉÉ„ÉàÔºâ
        document.querySelector('.form').onsubmit = e => {
          e.preventDefault();
          const input = document.querySelector('.input');
          ws.send(JSON.stringify({
            type: 'chat',
            id: myId,
            text: input.value
          }));
          input.value = '';
          input.focus();
        };
      }

      main();
    </script>
  </body>
</html>