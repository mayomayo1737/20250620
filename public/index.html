<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat+Drawing App</title>
    <style>
      .chat {
        display: flex;
        flex-direction: column;
        height: 50vh;
      }
      .messages {
        flex: 1;
        overflow-y: auto;
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .form {
        display: flex;
      }
      .input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
      }
      .submit {
        padding: 10px;
        border: 1px solid #ccc;
        background: #eee;
        cursor: pointer;
      }
      #toolbar {
        margin: 10px 0;
      }
      #toolbar > * {
        margin-right: 10px;
      }
      .stamp-btn {
        font-size: 24px;
        cursor: pointer;
        background: transparent;
        border: none;
      }
      .selected {
        outline: 2px solid #333;
      }
      #eraserBtn.active {
        background: #faa;
      }
    </style>
  </head>
  <body>
    <div class="chat">
      <ul class="messages"></ul>
      <form class="form">
        <input class="input" autocomplete="off" />
        <button class="submit">Send</button>
      </form>
    </div>

    <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
    <div id="toolbar">
      <!-- è‰²é¸æŠ -->
      <label>
        ç·šã®è‰²:
        <input type="color" id="colorPicker" value="#000000" />
      </label>
      <!-- ã‚¹ã‚¿ãƒ³ãƒ— -->
      <span>ã‚¹ã‚¿ãƒ³ãƒ—:</span>
      <button class="stamp-btn" data-stamp="ğŸŒ¸">ğŸŒ¸</button>
      <button class="stamp-btn" data-stamp="â­">â­</button>
      <button class="stamp-btn" data-stamp="ğŸ‘">ğŸ‘</button>
      <!-- æ¶ˆã—ã‚´ãƒ  -->
      <button id="eraserBtn">æ¶ˆã—ã‚´ãƒ </button>
      <!-- ã‚¯ãƒªã‚¢ -->
      <button id="clearBtn">ã‚¯ãƒªã‚¢</button>
    </div>

    <canvas
      id="canvas"
      width="600"
      height="600"
      style="border: solid 1px black"
    ></canvas>

    <script>
      function main() {
        const host = location.origin.replace(/^http/, 'ws');
        const ws = new WebSocket(host + '/ws');
        const myId = crypto.randomUUID().substr(0, 8);

        // DOM
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const colorPicker = document.getElementById('colorPicker');
        const stamps = document.querySelectorAll('.stamp-btn');
        const eraserBtn = document.getElementById('eraserBtn');
        const clearBtn = document.getElementById('clearBtn');

        // ãƒ„ãƒ¼ãƒ«çŠ¶æ…‹
        let tool = 'pen';         // 'pen' | 'stamp' | 'eraser'
        let currentStamp = null;

        // åˆæœŸè¨­å®š
        ctx.lineWidth = 5;
        ctx.lineCap = 'round';
        ctx.strokeStyle = colorPicker.value;

        // ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼
        colorPicker.addEventListener('input', () => {
          ctx.strokeStyle = colorPicker.value;
        });

        // ã‚¹ã‚¿ãƒ³ãƒ—é¸æŠ
        stamps.forEach(btn => {
          btn.addEventListener('click', () => {
            // åˆ‡ã‚Šæ›¿ãˆ
            if (tool === 'stamp' && currentStamp === btn.dataset.stamp) {
              // ã‚‚ã†ä¸€åº¦æŠ¼ã™ã¨ãƒšãƒ³ã«æˆ»ã™
              tool = 'pen';
              currentStamp = null;
              btn.classList.remove('selected');
            } else {
              tool = 'stamp';
              currentStamp = btn.dataset.stamp;
              // ãƒœã‚¿ãƒ³ãƒã‚¤ãƒ©ã‚¤ãƒˆ
              stamps.forEach(b => b.classList.remove('selected'));
              btn.classList.add('selected');
            }
            // ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¤ãƒƒãƒOFF
            eraserBtn.classList.remove('active');
            ctx.globalCompositeOperation = 'source-over';
          });
        });

        // æ¶ˆã—ã‚´ãƒ 
        eraserBtn.addEventListener('click', () => {
          if (tool === 'eraser') {
            // æ¶ˆã—ã‚´ãƒ OFFâ†’ãƒšãƒ³ã«æˆ»ã™
            tool = 'pen';
            eraserBtn.classList.remove('active');
            ctx.globalCompositeOperation = 'source-over';
          } else {
            tool = 'eraser';
            eraserBtn.classList.add('active');
            ctx.globalCompositeOperation = 'destination-out';
          }
          // ã‚¹ã‚¿ãƒ³ãƒ—é¸æŠè§£é™¤
          stamps.forEach(b => b.classList.remove('selected'));
          currentStamp = null;
        });

        // ã‚¯ãƒªã‚¢
        clearBtn.addEventListener('click', () => {
          clearCanvas();
          ws.send(JSON.stringify({ type: 'clear' }));
        });

        // ã‚¯ãƒªãƒƒã‚¯ã§ã‚¹ã‚¿ãƒ³ãƒ—é…ç½®
        canvas.addEventListener('click', (e) => {
          if (tool === 'stamp' && currentStamp) {
            const x = e.offsetX;
            const y = e.offsetY;
            drawStamp(currentStamp, x, y);
            ws.send(
              JSON.stringify({ type: 'stamp', stamp: currentStamp, x, y })
            );
            // ãƒšãƒ³ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã™
            tool = 'pen';
            stamps.forEach(b => b.classList.remove('selected'));
            currentStamp = null;
          }
        });

        // ãƒšãƒ³æç”»
        let drawing = false;
        canvas.addEventListener('mousedown', (e) => {
          if (tool === 'pen' || tool === 'eraser') {
            drawing = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
            ws.send(
              JSON.stringify({
                type: 'paint',
                control: 'mousedown',
                x: e.offsetX,
                y: e.offsetY
              })
            );
          }
        });
        canvas.addEventListener('mousemove', (e) => {
          if (drawing) {
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
            ws.send(
              JSON.stringify({
                type: 'paint',
                control: 'mousemove',
                x: e.offsetX,
                y: e.offsetY
              })
            );
          }
        });
        canvas.addEventListener('mouseup', (e) => {
          if (drawing) {
            drawing = false;
            ctx.beginPath();
            ws.send(
              JSON.stringify({
                type: 'paint',
                control: 'mouseup',
                x: e.offsetX,
                y: e.offsetY
              })
            );
          }
        });
        canvas.addEventListener('mouseout', (e) => {
          if (drawing) {
            drawing = false;
            ctx.beginPath();
            ws.send(
              JSON.stringify({
                type: 'paint',
                control: 'mouseout',
                x: e.offsetX,
                y: e.offsetY
              })
            );
          }
        });

        // WebSocketå—ä¿¡
        ws.onmessage = (ev) => {
          const msg = JSON.parse(ev.data);
          switch (msg.type) {
            case 'paint':
              handleRemotePaint(msg);
              break;
            case 'stamp':
              drawStamp(msg.stamp, msg.x, msg.y);
              break;
            case 'clear':
              clearCanvas();
              break;
            case 'chat':
              appendChat(msg);
              break;
          }
        };

        function handleRemotePaint({ control, x, y }) {
          if (control === 'mousedown') {
            ctx.beginPath();
            ctx.moveTo(x, y);
          } else if (control === 'mousemove') {
            ctx.lineTo(x, y);
            ctx.stroke();
          } else if (control === 'mouseup' || control === 'mouseout') {
            ctx.beginPath();
          }
        }

        function drawStamp(stamp, x, y) {
          ctx.save();
          ctx.font = '32px serif';
          ctx.textAlign = 'center';
          ctx.fillText(stamp, x, y + 10);
          ctx.restore();
        }

        function clearCanvas() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.beginPath();
        }

        // ãƒãƒ£ãƒƒãƒˆ
        function appendChat({ id, text }) {
          const ul = document.querySelector('.messages');
          const li = document.createElement('li');
          li.textContent =
            id === myId ? `(${id}) è‡ªåˆ†: ${text}` : `${id}: ${text}`;
          ul.appendChild(li);
          ul.scrollTop = ul.scrollHeight;
        }

        const form = document.querySelector('.form');
        form.onsubmit = (e) => {
          e.preventDefault();
          const input = document.querySelector('.input');
          ws.send(
            JSON.stringify({ type: 'chat', id: myId, text: input.value })
          );
          input.value = '';
          input.focus();
        };

        ws.onerror = (err) => console.error('WebSocket Error:', err);
      }

      main();
    </script>
  </body>
</html>