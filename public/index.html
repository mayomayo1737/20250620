<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat+Drawing App</title>
  <style>
    .chat {
      display: flex;
      flex-direction: column;
      height: 40vh;
      margin-bottom: 10px;
    }
    .messages {
      flex: 1;
      overflow-y: auto;
      list-style: none;
      padding: 0;
      margin: 0;
      border: 1px solid #ccc;
    }
    .form { display: flex; }
    .input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
    }
    .submit {
      padding: 10px;
      border: 1px solid #ccc;
      background: #eee;
      cursor: pointer;
    }
    #toolbar { margin: 10px 0; }
    #toolbar > * { margin-right: 10px; }
    .stamp-btn {
      font-size: 24px;
      cursor: pointer;
      background: transparent;
      border: none;
    }
    .selected { outline: 2px solid #333; }
    #eraserBtn.active { background: #faa; }
    canvas { touch-action: none; /* pointer events ç”¨ */ }
  </style>
</head>
<body>
  <!-- ãƒãƒ£ãƒƒãƒˆ -->
  <div class="chat">
    <ul class="messages"></ul>
    <form class="form">
      <input class="input" autocomplete="off" />
      <button class="submit">Send</button>
    </form>
  </div>

  <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
  <div id="toolbar">
    <label>
      ç·šã®è‰²:
      <input type="color" id="colorPicker" value="#000000"/>
    </label>
    <span>ã‚¹ã‚¿ãƒ³ãƒ—:</span>
    <button class="stamp-btn" data-stamp="ğŸŒ¸">ğŸŒ¸</button>
    <button class="stamp-btn" data-stamp="â­">â­</button>
    <button class="stamp-btn" data-stamp="ğŸ‘">ğŸ‘</button>
    <button id="eraserBtn">æ¶ˆã—ã‚´ãƒ </button>
    <button id="clearBtn">ã‚¯ãƒªã‚¢</button>
  </div>

  <!-- æç”»ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
  <canvas id="canvas" width="600" height="600"
          style="border:1px solid black"></canvas>

  <script>
    function main() {
      const host = location.origin.replace(/^http/, 'ws');
      const ws   = new WebSocket(host + '/ws');
      const myId = crypto.randomUUID().substr(0,8);

      // DOM
      const canvas      = document.getElementById('canvas');
      const ctx         = canvas.getContext('2d');
      const colorPicker = document.getElementById('colorPicker');
      const stamps      = document.querySelectorAll('.stamp-btn');
      const eraserBtn   = document.getElementById('eraserBtn');
      const clearBtn    = document.getElementById('clearBtn');

      // çŠ¶æ…‹å¤‰æ•°
      let tool         = 'pen';    // 'pen' | 'stamp' | 'eraser'
      let currentStamp = null;
      let drawing      = false;
      let prevX = 0, prevY = 0;

      // åˆæœŸè¨­å®š
      ctx.lineWidth       = 5;
      ctx.lineCap         = 'round';
      ctx.strokeStyle     = colorPicker.value;

      // è‰²å¤‰æ›´
      colorPicker.addEventListener('input', () => {
        ctx.strokeStyle = colorPicker.value;
      });

      // ã‚¹ã‚¿ãƒ³ãƒ—é¸æŠ
      stamps.forEach(btn => {
        btn.addEventListener('click', () => {
          if (tool==='stamp' && currentStamp===btn.dataset.stamp) {
            tool = 'pen'; currentStamp = null; btn.classList.remove('selected');
          } else {
            tool = 'stamp';
            currentStamp = btn.dataset.stamp;
            stamps.forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
          }
          eraserBtn.classList.remove('active');
          ctx.globalCompositeOperation = 'source-over';
        });
      });

      // æ¶ˆã—ã‚´ãƒ åˆ‡æ›¿
      eraserBtn.addEventListener('click', () => {
        if (tool==='eraser') {
          tool = 'pen';
          eraserBtn.classList.remove('active');
          ctx.globalCompositeOperation = 'source-over';
        } else {
          tool = 'eraser';
          eraserBtn.classList.add('active');
          ctx.globalCompositeOperation = 'destination-out';
        }
        stamps.forEach(b => b.classList.remove('selected'));
        currentStamp = null;
      });

      // ã‚¯ãƒªã‚¢
      clearBtn.addEventListener('click', () => {
        clearCanvas();
        ws.send(JSON.stringify({ type:'clear' }));
      });

      // ã‚¹ã‚¿ãƒ³ãƒ—é…ç½®
      canvas.addEventListener('click', e => {
        if (tool==='stamp' && currentStamp) {
          const x = e.offsetX, y = e.offsetY;
          drawStamp(currentStamp, x, y);
          ctx.beginPath();  // ãƒ‘ã‚¹ã‚’åˆ‡ã‚‹
          ws.send(JSON.stringify({
            type: 'stamp',
            stamp: currentStamp,
            x, y
          }));
          tool = 'pen';
          stamps.forEach(b => b.classList.remove('selected'));
          currentStamp = null;
        }
      });

      // ãƒã‚¤ãƒ³ã‚¿ãƒ¼æç”»ï¼ˆBezier è£œé–“ï¼‰
      canvas.addEventListener('pointerdown', e => {
        if (tool==='pen' || tool==='eraser') {
          drawing = true;
          prevX = e.offsetX; prevY = e.offsetY;
          ctx.beginPath();
          ctx.moveTo(prevX, prevY);
          canvas.setPointerCapture(e.pointerId);
          ws.send(JSON.stringify({
            type:'paint',
            control:'mousedown',
            x: prevX, y: prevY
          }));
        }
      });

      canvas.addEventListener('pointermove', e => {
        if (!drawing || !(tool==='pen'||tool==='eraser')) return;
        const x = e.offsetX, y = e.offsetY;
        // ä¸­ç‚¹ã‚’è¨ˆç®—ã—ã¦æ»‘ã‚‰ã‹ã«
        const midX = (prevX + x) / 2;
        const midY = (prevY + y) / 2;
        ctx.quadraticCurveTo(prevX, prevY, midX, midY);
        ctx.stroke();
        prevX = x; prevY = y;
        ws.send(JSON.stringify({
          type:'paint',
          control:'mousemove',
          x, y
        }));
      });

      canvas.addEventListener('pointerup', e => {
        if (drawing) {
          drawing = false;
          ctx.beginPath();
          canvas.releasePointerCapture(e.pointerId);
          ws.send(JSON.stringify({
            type:'paint',
            control:'mouseup',
            x: e.offsetX, y: e.offsetY
          }));
        }
      });

      // WebSocket å—ä¿¡
      ws.onmessage = ev => {
        const msg = JSON.parse(ev.data);
        switch(msg.type) {
          case 'paint':
            handleRemotePaint(msg);
            break;
          case 'stamp':
            drawStamp(msg.stamp, msg.x, msg.y);
            ctx.beginPath();
            break;
          case 'clear':
            clearCanvas();
            break;
          case 'chat':
            appendChat(msg);
            break;
        }
      };
      ws.onerror = err => console.error('WebSocket Error:', err);

      // ãƒªãƒ¢ãƒ¼ãƒˆæç”»
      function handleRemotePaint({control, x, y}) {
        if (control==='mousedown') {
          ctx.beginPath(); ctx.moveTo(x, y);
        } else if (control==='mousemove') {
          ctx.lineTo(x, y); ctx.stroke();
        } else if (control==='mouseup') {
          ctx.beginPath();
        }
      }

      // ã‚¹ã‚¿ãƒ³ãƒ—æœ¬ä½“
      function drawStamp(stamp, x, y) {
        ctx.save();
        ctx.font = '32px serif';
        ctx.textAlign = 'center';
        ctx.fillText(stamp, x, y + 10);
        ctx.restore();
      }

      // å…¨æ¶ˆå»
      function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.beginPath();
      }

      // ãƒãƒ£ãƒƒãƒˆè¿½åŠ 
      function appendChat({id, text}) {
        const ul = document.querySelector('.messages');
        const li = document.createElement('li');
        li.textContent =
          id === myId ? `(${id}) è‡ªåˆ†: ${text}` : `${id}: ${text}`;
        ul.appendChild(li);
        ul.scrollTop = ul.scrollHeight;
      }

      // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
      document.querySelector('.form').onsubmit = e => {
        e.preventDefault();
        const input = document.querySelector('.input');
        ws.send(JSON.stringify({
          type:'chat', id:myId, text:input.value
        }));
        input.value=''; input.focus();
      };
    }

    main();
  </script>
</body>
</html>